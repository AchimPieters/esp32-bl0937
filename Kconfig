menu "BL0973 (BL09x7) Energy Meter"

config BL0973_ENABLE
    bool "Enable BL0973 driver"
    default y
    help
        Enable the BL0973/BL0937-style energy meter driver.

config BL0973_GPIO_CF
    int "GPIO for CF (active power / overcurrent pulse output)"
    default 4
    range -1 48
    help
        GPIO connected to CF. Set to -1 to disable (not recommended).

config BL0973_GPIO_CF1
    int "GPIO for CF1 (RMS pulse output)"
    default 5
    range -1 48
    help
        GPIO connected to CF1. Set to -1 to disable.

config BL0973_GPIO_SEL
    int "GPIO for SEL (CF1 select)"
    default 6
    range -1 48
    help
        GPIO connected to SEL. SEL=0 => IRMS on CF1, SEL=1 => VRMS on CF1.

config BL0973_SEL_ACTIVE_HIGH
    bool "SEL active-high (default)"
    default y
    help
        If enabled: SEL GPIO level '1' means SEL=1.
        If disabled: logic is inverted.

config BL0973_CF_ACTIVE_HIGH
    bool "CF/CF1 pulses are active-high (default)"
    default y
    help
        Datasheet indicates active high pulses. Disable only if your board inverts the signal.

config BL0973_USE_GPIO_PULLUPS
    bool "Enable internal pull-ups on CF/CF1 (if needed)"
    default n
    help
        Enable internal pull-ups. Normally not required if you have external pull resistors.


config BL0973_AUTOSTART
    bool "Autostart measuring (start timer automatically)"
    default y
    help
        If enabled, the component starts measuring immediately after init.
        If disabled, call bl0973_start() manually.

config BL0973_UPDATE_PERIOD_MS
    int "Update period (ms)"
    default 200
    range 50 2000
    help
        Period at which the driver reads pulse counts and updates computed values.

config BL0973_TOGGLE_SEL_EVERY_UPDATE
    bool "Auto toggle SEL every update"
    default y
    help
        If enabled, the driver alternates CF1 between IRMS and VRMS on each update tick.

config BL0973_SEL_STABLE_US
    int "SEL settle time (us)"
    default 50
    range 10 5000
    help
        Delay after toggling SEL before counting pulses is considered stable.

config BL0973_EMA_ALPHA_PERMILLE
    int "Exponential moving average alpha (permille)"
    default 250
    range 0 1000
    help
        0 = no update, 1000 = no filtering (raw).
        Recommended 150..400.


config BL0973_SIGNAL_TIMEOUT_MS
    int "Signal timeout (ms) for validity flags"
    default 3000
    range 100 600000
    help
        If no relevant pulses arrive for this duration, the corresponding measurement is marked invalid.

config BL0973_MIN_VALID_FREQ_HZ
    int "Minimum valid pulse frequency (mHz)"
    default 200
    range 0 100000
    help
        Minimum pulse frequency for a channel to be considered valid, in milli-Hz.
        0 disables the frequency threshold.

config BL0973_VREF_MV
    int "Chip reference voltage (mV)"
    default 1218
    range 1000 1400
    help
        On-chip voltage reference typical 1.218V.

config BL0973_SHUNT_UOHM
    int "Shunt resistor (micro-ohm)"
    default 1000
    range 100 10000
    help
        Value of the current shunt in micro-ohm. Example: 1mΩ => 1000uΩ.

config BL0973_DIVIDER_RATIO_NUM
    int "Divider ratio numerator (Vinput = Vmains * num/den)"
    default 1
    range 1 1000000

config BL0973_DIVIDER_RATIO_DEN
    int "Divider ratio denominator (Vinput = Vmains * num/den)"
    default 1000
    range 1 1000000

config BL0973_CAL_VOLTAGE_PERMILLE
    int "Voltage calibration (permille)"
    default 1000
    range 100 10000
    help
        1000 = 1.000. Multiply computed voltage by this factor / 1000.

config BL0973_CAL_CURRENT_PERMILLE
    int "Current calibration (permille)"
    default 1000
    range 100 10000

config BL0973_CAL_POWER_PERMILLE
    int "Power calibration (permille)"
    default 1000
    range 100 10000

config BL0973_CAL_VOLTAGE_OFFSET_MV
    int "Voltage offset (mV) added after calibration"
    default 0
    range -50000 50000

config BL0973_CAL_CURRENT_OFFSET_MA
    int "Current offset (mA) added after calibration"
    default 0
    range -50000 50000


config BL0973_ENABLE_APPARENT_POWER
    bool "Compute apparent power (VA)"
    default y

config BL0973_ENABLE_REACTIVE_POWER
    bool "Compute reactive power (var) (sqrt(S^2-P^2))"
    default y


config BL0973_ENABLE_NVS_ENERGY
    bool "Persist energy counter (CF pulses) in NVS"
    default n
    help
        If enabled, the component periodically saves the accumulated CF pulse counter to NVS,
        so energy can continue after reboot.

config BL0973_NVS_ENERGY_SAVE_INTERVAL_S
    int "Energy save interval (seconds)"
    depends on BL0973_ENABLE_NVS_ENERGY
    default 60
    range 1 86400

config BL0973_NVS_ENERGY_KEY
    string "NVS key for energy pulse counter"
    depends on BL0973_ENABLE_NVS_ENERGY
    default "pulses"

config BL0973_ENABLE_NVS_CALIBRATION
    bool "Store calibration in NVS (optional)"
    default n
    help
        If enabled, calibration factors can be saved and restored from NVS.

config BL0973_NVS_NAMESPACE
    string "NVS namespace"
    depends on BL0973_ENABLE_NVS_CALIBRATION
    default "bl0973"

config BL0973_ENABLE_RELAY_CUTOFF
    bool "Enable relay cutoff output for overcurrent protection"
    default n

config BL0973_GPIO_RELAY
    int "GPIO for relay control"
    depends on BL0973_ENABLE_RELAY_CUTOFF
    default 7
    range -1 48

config BL0973_RELAY_ACTIVE_HIGH
    bool "Relay active-high"
    depends on BL0973_ENABLE_RELAY_CUTOFF
    default y


config BL0973_RELAY_INITIAL_ON
    bool "Relay initial state ON"
    depends on BL0973_ENABLE_RELAY_CUTOFF
    default y
    help
        If enabled, relay GPIO is set to ON during init.

config BL0973_RELAY_DEFAULT_ON_AFTER_RECOVER
    bool "Relay defaults to ON after overcurrent recover"
    depends on BL0973_ENABLE_RELAY_CUTOFF
    default y
    help
        If enabled, relay will automatically turn ON when cooldown ends.
        If disabled, relay stays OFF after recover until bl0973_relay_set(true) is called.


config BL0973_OVERCURRENT_THRESHOLD_MA
    int "Overcurrent threshold (mA)"
    default 16000
    range 1000 60000

config BL0973_OVERCURRENT_DEBOUNCE_MS
    int "Overcurrent debounce (ms)"
    default 200
    range 0 5000

config BL0973_OVERCURRENT_COOLDOWN_S
    int "Overcurrent cooldown (s)"
    default 30
    range 1 3600

config BL0973_ENABLE_HW_OC_DETECT
    bool "Use CF over-current pulse (6.7kHz) as immediate trip (optional)"
    default y
    help
        Datasheet: CF outputs ~6.7kHz pulse when IC detects over-current condition.

config BL0973_HW_OC_FREQ_HZ
    int "Hardware over-current frequency (Hz)"
    depends on BL0973_ENABLE_HW_OC_DETECT
    default 6700
    range 1000 50000

config BL0973_HW_OC_FREQ_TOLERANCE_PCT
    int "Hardware OC frequency tolerance (%)"
    depends on BL0973_ENABLE_HW_OC_DETECT
    default 15
    range 1 50

endmenu
